<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Void - Space Defender (Ultimate Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- FIREBASE SDKs-->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* --- Estilo Global --- */
        :root {
            --neon-blue: #00f3ff;
            --neon-pink: #ff00ff;
            --neon-green: #00ff9d;
            --bg-dark: #050510;
            --diamond-color: #b9f2ff;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: var(--bg-dark);
            overflow: hidden;
            user-select: none;
        }

        .cyber-grid {
            position: fixed;
            top: 0; left: 0; width: 200%; height: 200%;
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
            transform: perspective(500px) rotateX(60deg) translateY(-100px) translateZ(-200px);
            animation: gridMove 20s linear infinite;
            z-index: -1;
            pointer-events: none;
        }

        @keyframes gridMove {
            0% { transform: perspective(500px) rotateX(60deg) translateY(0) translateZ(-200px); }
            100% { transform: perspective(500px) rotateX(60deg) translateY(40px) translateZ(-200px); }
        }

        canvas {
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.15);
            border: 1px solid rgba(0, 243, 255, 0.3);
            background: rgba(0,0,0,0.6);
            border-radius: 4px;
        }
        
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .glass-panel {
            background: rgba(12, 12, 20, 0.85);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }

        .btn-cyber {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            cursor: pointer;
        }
        
        .btn-cyber:hover {
            text-shadow: 0 0 8px currentColor;
            transform: translateY(-2px);
        }

        .shop-card {
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .shop-card:hover:not(:disabled) {
            border-color: var(--neon-blue);
            background: rgba(0, 243, 255, 0.1);
        }
        .shop-card:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .hp-container {
            width: 200px;
            height: 10px;
            background: #333;
            transform: skewX(-20deg);
            overflow: hidden;
            border: 1px solid #555;
        }
        .hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff0000, #ff5500);
            width: 100%;
            transition: width 0.2s ease-out;
            box-shadow: 0 0 10px #ff0000;
        }

        .diamond-text {
            color: var(--diamond-color);
            text-shadow: 0 0 10px var(--diamond-color);
        }
        
        .login-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9); z-index: 100;
            display: flex; align-items: center; justify-content: center;
        }

        /* Dash Effect Indicator */
        .dash-ready { box-shadow: 0 0 15px #00ff9d; border-color: #00ff9d; }

        /* Custom Glow for Special Buttons */
        .box-shadow-cyan { box-shadow: 0 0 15px rgba(0, 243, 255, 0.3); }
        .text-shadow-cyan { text-shadow: 0 0 5px rgba(0, 243, 255, 0.8); }
        
        /* Power-up effects */
        .powerup-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #00ff9d;
            font-size: 12px;
            color: #00ff9d;
            display: none;
        }
        
        /* Achievement popup */
        .achievement-popup {
            position: fixed;
            top: 20px;
            right: -300px;
            background: rgba(0,0,0,0.9);
            border-left: 4px solid gold;
            padding: 15px;
            border-radius: 4px;
            transition: right 0.5s ease;
            z-index: 1000;
            width: 250px;
        }
        
        .achievement-popup.show {
            right: 20px;
        }
        
        /* Mission tracker */
        .mission-tracker {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ff00ff;
            max-width: 300px;
        }
        
        /* Ship selection */
        .ship-option {
            border: 2px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .ship-option.selected {
            border-color: #00f3ff;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.5);
        }
        
        .ship-option:hover:not(.selected) {
            border-color: rgba(0, 243, 255, 0.3);
        }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(0, 243, 255, 0.5);
            border-radius: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 243, 255, 0.8);
        }

    </style>
</head>
<body class="h-screen w-screen flex items-center justify-center text-white">

    <div class="cyber-grid"></div>

   <!-- TELA DE LOGIN -->
    <div id="loginScreen" class="login-overlay">
        <div class="glass-panel p-8 rounded-xl text-center max-w-md w-full border border-cyan-500/30 relative">
            <h2 class="text-3xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-500">
                IDENTIFICA√á√ÉO PILOTO
            </h2>
            
            <!-- Login Email/Senha -->
            <div class="space-y-3 mb-6 text-left">
                <div>
                    <input type="text" id="regName" placeholder="Nome do Piloto (Apenas para Registro)" 
                        class="w-full bg-gray-900/50 border border-gray-600 text-white px-4 py-2 rounded focus:border-cyan-400 outline-none text-sm hidden">
                </div>
                <input type="email" id="emailInput" placeholder="Email de Acesso" 
                    class="w-full bg-gray-900/50 border border-gray-600 text-white px-4 py-2 rounded focus:border-cyan-400 outline-none">
                <input type="password" id="passInput" placeholder="Senha de Seguran√ßa" 
                    class="w-full bg-gray-900/50 border border-gray-600 text-white px-4 py-2 rounded focus:border-cyan-400 outline-none">
                
                <div class="flex gap-2 pt-2">
                    <button onclick="authManager.loginEmail()" class="flex-1 bg-cyan-700 hover:bg-cyan-600 text-white font-bold py-2 rounded transition text-sm">
                        ENTRAR
                    </button>
                    <button onclick="authManager.toggleRegisterMode()" id="btnToggleReg" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 rounded transition text-sm">
                        CRIAR CONTA
                    </button>
                </div>
                <button onclick="authManager.registerEmail()" id="btnConfirmReg" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 rounded transition text-sm hidden">
                    CONFIRMAR REGISTRO
                </button>
            </div>

            <div class="relative flex py-2 items-center">
                <div class="flex-grow border-t border-gray-700"></div>
                <span class="flex-shrink-0 mx-4 text-gray-500 text-xs">OU CONECTE COM</span>
                <div class="flex-grow border-t border-gray-700"></div>
            </div>

            <!-- Bot√£o Google -->
            <button onclick="authManager.loginGoogle()" class="w-full bg-white text-black font-bold py-2 rounded mb-3 hover:bg-gray-200 transition flex items-center justify-center gap-2 text-sm">
                <svg class="w-4 h-4" viewBox="0 0 24 24"><path fill="currentColor" d="M21.35 11.1h-9.17v2.73h6.51c-.33 3.81-3.5 5.44-6.5 5.44C8.36 19.27 5 16.25 5 12c0-4.1 3.2-7.27 7.2-7.27c3.09 0 4.9 1.97 4.9 1.97L19 4.72S16.56 2 12.1 2C6.42 2 2.03 6.8 2.03 12c0 5.05 4.13 10 10.22 10c5.35 0 9.25-3.67 9.25-9.09c0-1.15-.15-1.81-.15-1.81Z"/></svg>
                GOOGLE
            </button>
            
            <!-- Bot√£o An√¥nimo -->
            <button onclick="authManager.loginAnonymous()" class="w-full bg-gray-800 border border-gray-600 text-gray-300 font-bold py-2 rounded hover:bg-gray-700 hover:text-white transition flex items-center justify-center gap-2 text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                ENTRAR COMO VISITANTE (SALVA PROGRESSO)
            </button>

            <div id="loginStatus" class="mt-4 text-xs text-red-400 h-4 font-mono min-h-[20px]"></div>
        </div>
    </div>

    <!-- HUD -->
    <div id="uiLayer" class="absolute inset-0 pointer-events-none p-6 hidden flex-col justify-between z-10">
        <div class="flex justify-between items-start w-full max-w-5xl mx-auto">
            <div class="flex flex-col gap-2">
                <div class="flex items-center gap-2">
                    <span class="text-neon-pink font-bold text-xl tracking-widest">HULL</span>
                    <div class="hp-container">
                        <div id="hpBar" class="hp-fill"></div>
                    </div>
                </div>
                <div class="text-sm text-gray-400 font-mono">WAVE: <span id="waveDisplay" class="text-white text-lg">1</span></div>
                
                <!-- Indicador de Dash -->
                <div id="dashIndicator" class="hidden mt-2 items-center gap-2">
                    <span class="text-xs text-green-400 font-bold">DASH [SHIFT]</span>
                    <div class="w-24 h-2 bg-gray-800 rounded overflow-hidden border border-gray-600">
                        <div id="dashBar" class="h-full bg-green-400 w-full transition-all duration-100"></div>
                    </div>
                </div>
                
                <!-- Indicadores de Power-ups -->
                <div id="powerupIndicators" class="flex flex-col gap-1 mt-2">
                    <!-- Ser√° preenchido dinamicamente -->
                </div>
            </div>

            <div class="text-center">
                <div class="text-xs text-gray-500 tracking-[0.5em] uppercase">Score</div>
                <div id="scoreDisplay" class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-400">0</div>
            </div>

            <div class="flex flex-col items-end gap-2">
                <div class="flex items-center gap-2 text-yellow-400">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span id="coinDisplay" class="text-2xl font-mono font-bold">0</span>
                </div>
                <div class="text-xs text-cyan-400 animate-pulse mt-1 pointer-events-auto">
                    [ESPA√áO] Loja | [SHIFT] Dash (Se desbloqueado)
                </div>
            </div>
        </div>
        
        <!-- Rastreador de Miss√µes -->
        <div id="missionTracker" class="mission-tracker hidden">
            <div class="text-purple-400 font-bold mb-1">MISS√ÉO ATIVA</div>
            <div id="missionText" class="text-sm text-gray-300">Destrua 10 inimigos</div>
            <div class="flex items-center mt-1">
                <div class="w-full bg-gray-700 h-2 rounded-full overflow-hidden">
                    <div id="missionProgress" class="h-full bg-purple-500 transition-all duration-300" style="width: 0%"></div>
                </div>
                <span id="missionProgressText" class="text-xs text-gray-400 ml-2">0/10</span>
            </div>
        </div>
    </div>

    <!-- Menu Principal -->
    <div id="mainMenu" class="absolute z-20 flex flex-col items-center justify-center text-center hidden">
        <div class="absolute top-4 right-4 text-right">
            <div id="userName" class="text-sm text-gray-400">Visitante</div>
            <div class="flex items-center justify-end gap-2 text-xl font-bold diamond-text">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z" />
                </svg>
                <span id="diamondDisplay">0</span>
            </div>
        </div>

        <h1 class="text-7xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 via-blue-500 to-purple-600 drop-shadow-[0_0_15px_rgba(0,243,255,0.5)]">
            NEON VOID
        </h1>
        <p class="text-gray-400 mb-10 tracking-widest text-lg">DEFESA ORBITAL // SISTEMA ONLINE</p>
        
        <div class="flex gap-4">
            <button onclick="showShipSelection()" class="btn-cyber bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-4 px-12 text-xl shadow-[0_0_20px_rgba(6,182,212,0.5)]">
                INICIAR MISS√ÉO
            </button>
            <button onclick="toggleHangar()" class="btn-cyber bg-purple-700 hover:bg-purple-600 text-white font-bold py-4 px-8 text-xl shadow-[0_0_20px_rgba(147,51,234,0.5)]">
                HANGAR (UPGRADES)
            </button>
            <button onclick="leaderboard.open()" class="btn-cyber bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-4 px-8 text-xl shadow-[0_0_20px_rgba(202,138,4,0.5)]">
                RANKING
            </button>
            <button onclick="showAchievements()" class="btn-cyber bg-green-700 hover:bg-green-600 text-white font-bold py-4 px-8 text-xl shadow-[0_0_20px_rgba(5,150,105,0.5)]">
                CONQUISTAS
            </button>
        </div>
        
        <div class="mt-8 text-sm text-gray-500 font-mono space-x-4">
            <span>[WASD] Mover</span>
            <span>[MOUSE] Atirar</span>
            <span>[SHIFT] Dash</span>
            <span>[ESPA√áO] Loja In-Game</span>
        </div>
    </div>

    <!-- Sele√ß√£o de Nave -->
    <div id="shipSelectionModal" class="absolute inset-0 z-30 bg-black/90 backdrop-blur-md hidden flex items-center justify-center">
        <div class="glass-panel p-8 max-w-4xl w-full rounded-xl border border-cyan-500/50">
            <div class="flex justify-between items-center mb-8 border-b border-cyan-800 pb-4">
                <h2 class="text-3xl font-bold text-cyan-400">SELECIONE SUA NAVE</h2>
                <button onclick="hideShipSelection()" class="text-gray-400 hover:text-white">‚úï</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Nave B√°sica -->
                <div id="ship-basic" class="ship-option p-6 rounded bg-gray-800/80 text-center group border border-gray-700 selected" onclick="selectShip('basic')">
                    <div class="text-cyan-400 font-bold text-xl mb-4">INTERCEPTOR</div>
                    <div class="flex justify-center mb-4">
                        <div class="w-16 h-16 bg-gradient-to-br from-cyan-400 to-blue-600 rounded-full flex items-center justify-center">
                            <div class="w-8 h-8 bg-black rounded-full"></div>
                        </div>
                    </div>
                    <div class="text-sm text-gray-400 mb-4">Nave equilibrada com bom desempenho geral.</div>
                    <div class="text-xs text-gray-500 space-y-1">
                        <div>HP: 100 | Velocidade: 4</div>
                        <div>Dano: 10 | Cad√™ncia: 25</div>
                    </div>
                </div>

                <!-- Nave Tanque -->
                <div id="ship-tank" class="ship-option p-6 rounded bg-gray-800/80 text-center group border border-gray-700" onclick="selectShip('tank')">
                    <div class="text-red-400 font-bold text-xl mb-4">DESTRUIDOR</div>
                    <div class="flex justify-center mb-4">
                        <div class="w-20 h-16 bg-gradient-to-br from-red-500 to-orange-600 rounded flex items-center justify-center">
                            <div class="w-10 h-8 bg-black rounded"></div>
                        </div>
                    </div>
                    <div class="text-sm text-gray-400 mb-4">Nave resistente com maior vida e dano.</div>
                    <div class="text-xs text-gray-500 space-y-1">
                        <div>HP: 150 | Velocidade: 3</div>
                        <div>Dano: 15 | Cad√™ncia: 30</div>
                    </div>
                </div>

                <!-- Nave R√°pida -->
                <div id="ship-speed" class="ship-option p-6 rounded bg-gray-800/80 text-center group border border-gray-700" onclick="selectShip('speed')">
                    <div class="text-green-400 font-bold text-xl mb-4">CORREDOR</div>
                    <div class="flex justify-center mb-4">
                        <div class="w-12 h-16 bg-gradient-to-br from-green-400 to-emerald-600 rounded-full flex items-center justify-center">
                            <div class="w-6 h-8 bg-black rounded-full"></div>
                        </div>
                    </div>
                    <div class="text-sm text-gray-400 mb-4">Nave veloz com alta cad√™ncia de tiro.</div>
                    <div class="text-xs text-gray-500 space-y-1">
                        <div>HP: 80 | Velocidade: 6</div>
                        <div>Dano: 8 | Cad√™ncia: 15</div>
                    </div>
                </div>
            </div>

            <div class="flex justify-center gap-4">
                <button onclick="hideShipSelection()" class="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded font-bold">
                    VOLTAR
                </button>
                <button onclick="startGame()" class="px-6 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded font-bold">
                    CONFIRMAR E INICIAR
                </button>
            </div>
        </div>
    </div>

    <!-- HANGAR -->
    <div id="hangarModal" class="absolute inset-0 z-30 bg-black/90 backdrop-blur-md hidden flex items-center justify-center">
        <div class="glass-panel p-8 max-w-5xl w-full rounded-xl border border-purple-500/50">
            <div class="flex justify-between items-center mb-8 border-b border-purple-800 pb-4">
                <h2 class="text-3xl font-bold text-purple-400">HANGAR DE TECNOLOGIA PERMANENTE</h2>
                <div class="text-cyan-300 font-mono text-xl flex items-center gap-2">
                    DIAMANTES: <span id="hangarDiamonds">0</span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Upgrade 1: Escudo -->
                <button id="permShield" class="shop-card p-6 rounded bg-gray-800/80 text-left group border border-blue-900" onclick="permShop.buy('shield')">
                    <div class="flex justify-between">
                        <div class="text-blue-400 font-bold text-xl group-hover:text-blue-300">ESCUDO DE PLASMA</div>
                        <div id="status-shield" class="text-xs bg-gray-700 px-2 py-1 rounded">BLOQUEADO</div>
                    </div>
                    <div class="text-sm text-gray-400 mt-2 h-12">Inicia cada miss√£o com +50% de Integridade de Casco (HP).</div>
                    <div class="flex justify-between items-end mt-4">
                        <div class="text-xs text-gray-500 font-mono">PASSIVO</div>
                        <div class="text-cyan-300 font-bold text-lg flex items-center gap-1">
                            <span class="text-xs">‚ô¶</span> 10
                        </div>
                    </div>
                </button>

                <!-- Upgrade 2: Magneto -->
                <button id="permMagnet" class="shop-card p-6 rounded bg-gray-800/80 text-left group border border-yellow-900" onclick="permShop.buy('magnet')">
                    <div class="flex justify-between">
                        <div class="text-yellow-400 font-bold text-xl group-hover:text-yellow-300">RAIO TRATOR MKII</div>
                        <div id="status-magnet" class="text-xs bg-gray-700 px-2 py-1 rounded">BLOQUEADO</div>
                    </div>
                    <div class="text-sm text-gray-400 mt-2 h-12">Aumenta significativamente o alcance de coleta de moedas.</div>
                    <div class="flex justify-between items-end mt-4">
                        <div class="text-xs text-gray-500 font-mono">PASSIVO</div>
                        <div class="text-cyan-300 font-bold text-lg flex items-center gap-1">
                            <span class="text-xs">‚ô¶</span> 25
                        </div>
                    </div>
                </button>

                <!-- Upgrade 3: Dash -->
                <button id="permDash" class="shop-card p-6 rounded bg-gray-800/80 text-left group border border-green-900" onclick="permShop.buy('dash')">
                    <div class="flex justify-between">
                        <div class="text-green-400 font-bold text-xl group-hover:text-green-300">HYPER DASH</div>
                        <div id="status-dash" class="text-xs bg-gray-700 px-2 py-1 rounded">BLOQUEADO</div>
                    </div>
                    <div class="text-sm text-gray-400 mt-2 h-12">Habilidade Ativa [SHIFT]. Impulso r√°pido com invencibilidade tempor√°ria.</div>
                    <div class="flex justify-between items-end mt-4">
                        <div class="text-xs text-gray-500 font-mono">ATIVO</div>
                        <div class="text-cyan-300 font-bold text-lg flex items-center gap-1">
                            <span class="text-xs">‚ô¶</span> 50
                        </div>
                    </div>
                </button>

                <!-- Upgrade 4: Rapid Fire -->
                <button id="permRapidFire" class="shop-card p-6 rounded bg-gray-800/80 text-left group border border-red-900" onclick="permShop.buy('rapidFire')">
                    <div class="flex justify-between">
                        <div class="text-red-400 font-bold text-xl group-hover:text-red-300">N√öCLEO DE F√ìTONS</div>
                        <div id="status-rapidFire" class="text-xs bg-gray-700 px-2 py-1 rounded">BLOQUEADO</div>
                    </div>
                    <div class="text-sm text-gray-400 mt-2 h-12">Sobrecarrega os canh√µes. Atira 30% mais r√°pido permanentemente.</div>
                    <div class="flex justify-between items-end mt-4">
                        <div class="text-xs text-gray-500 font-mono">PASSIVO</div>
                        <div class="text-cyan-300 font-bold text-lg flex items-center gap-1">
                            <span class="text-xs">‚ô¶</span> 60
                        </div>
                    </div>
                </button>

                <!-- Upgrade 5: Greed Protocol -->
                <button id="permGreed" class="shop-card p-6 rounded bg-gray-800/80 text-left group border border-yellow-600" onclick="permShop.buy('greed')">
                    <div class="flex justify-between">
                        <div class="text-yellow-400 font-bold text-xl group-hover:text-yellow-300">PROTOCOLO GAN√ÇNCIA</div>
                        <div id="status-greed" class="text-xs bg-gray-700 px-2 py-1 rounded">BLOQUEADO</div>
                    </div>
                    <div class="text-sm text-gray-400 mt-2 h-12">Inicia todas as miss√µes com 500 Cr√©ditos para gastar na loja.</div>
                    <div class="flex justify-between items-end mt-4">
                        <div class="text-xs text-gray-500 font-mono">PASSIVO</div>
                        <div class="text-cyan-300 font-bold text-lg flex items-center gap-1">
                            <span class="text-xs">‚ô¶</span> 40
                        </div>
                    </div>
                </button>
                
                <!-- Upgrade 6: Power-up Chance -->
                <button id="permPowerup" class="shop-card p-6 rounded bg-gray-800/80 text-left group border border-pink-600" onclick="permShop.buy('powerup')">
                    <div class="flex justify-between">
                        <div class="text-pink-400 font-bold text-xl group-hover:text-pink-300">SORTE DO COMBATE</div>
                        <div id="status-powerup" class="text-xs bg-gray-700 px-2 py-1 rounded">BLOQUEADO</div>
                    </div>
                    <div class="text-sm text-gray-400 mt-2 h-12">Aumenta a chance de inimigos droparem power-ups em 15%.</div>
                    <div class="flex justify-between items-end mt-4">
                        <div class="text-xs text-gray-500 font-mono">PASSIVO</div>
                        <div class="text-cyan-300 font-bold text-lg flex items-center gap-1">
                            <span class="text-xs">‚ô¶</span> 35
                        </div>
                    </div>
                </button>
            </div>

            <div class="mt-8 text-center">
                <button onclick="toggleHangar()" class="px-8 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded font-bold uppercase text-sm tracking-wider">
                    VOLTAR AO MENU
                </button>
            </div>
        </div>
    </div>

    <!-- RANKING MODAL -->
    <div id="leaderboardModal" class="absolute inset-0 z-30 bg-black/90 backdrop-blur-md hidden flex items-center justify-center">
        <div class="glass-panel p-8 max-w-2xl w-full rounded-xl border border-yellow-500/50">
            <div class="flex justify-between items-center mb-6 border-b border-yellow-800 pb-4">
                <h2 class="text-3xl font-bold text-yellow-400">TOP COMANDANTES</h2>
                <button onclick="leaderboard.close()" class="text-gray-400 hover:text-white">‚úï</button>
            </div>

            <!-- Cabe√ßalho da Tabela -->
            <div class="grid grid-cols-3 text-cyan-300 font-bold mb-4 px-4 text-sm tracking-widest">
                <div class="text-left">POSI√á√ÉO</div>
                <div class="text-center">PILOTO</div>
                <div class="text-right">RECORD (PONTOS)</div>
            </div>

            <!-- Lista Din√¢mica -->
            <div id="leaderboardList" class="space-y-2 max-h-96 overflow-y-auto pr-2 custom-scrollbar">
                <div class="text-center text-gray-500 py-10">Carregando dados da rede neural...</div>
            </div>

            <div class="mt-8 text-center">
                <button onclick="leaderboard.close()" class="px-8 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded font-bold uppercase text-sm tracking-wider">
                    FECHAR
                </button>
            </div>
        </div>
    </div>
    
    <!-- CONQUISTAS MODAL -->
    <div id="achievementsModal" class="absolute inset-0 z-30 bg-black/90 backdrop-blur-md hidden flex items-center justify-center">
        <div class="glass-panel p-8 max-w-4xl w-full rounded-xl border border-green-500/50">
            <div class="flex justify-between items-center mb-6 border-b border-green-800 pb-4">
                <h2 class="text-3xl font-bold text-green-400">CONQUISTAS</h2>
                <button onclick="hideAchievements()" class="text-gray-400 hover:text-white">‚úï</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto pr-2 custom-scrollbar">
                <!-- Conquistas ser√£o preenchidas dinamicamente -->
            </div>

            <div class="mt-8 text-center">
                <button onclick="hideAchievements()" class="px-8 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded font-bold uppercase text-sm tracking-wider">
                    FECHAR
                </button>
            </div>
        </div>
    </div>

    <!-- Loja In-Game -->
    <div id="shopModal" class="absolute inset-0 z-30 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center">
        <div class="glass-panel p-8 max-w-4xl w-full rounded-xl transform transition-all relative">
            <div class="flex justify-between items-center mb-8 border-b border-gray-700 pb-4">
                <h2 class="text-3xl font-bold text-cyan-400">ESTA√á√ÉO DE UPGRADE (SESS√ÉO)</h2>
                <div class="text-yellow-400 font-mono text-xl flex items-center gap-2">
                    CR√âDITOS: <span id="shopCoins">0</span>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                 <button id="btnDmg" class="shop-card p-4 rounded bg-gray-800/50 text-left group" onclick="shop.buy('damage')">
                    <div class="text-red-400 font-bold mb-1">POT√äNCIA</div>
                    <div class="text-xs text-gray-400">Dano +</div>
                    <div class="flex justify-between mt-2"><span id="lvl-damage" class="text-gray-500">1</span> <span id="cost-damage" class="text-yellow-400">100</span></div>
                    <div class="h-1 bg-gray-700 mt-2"><div id="bar-damage" class="h-full bg-red-500 w-[10%]"></div></div>
                </button>
                <button id="btnSpd" class="shop-card p-4 rounded bg-gray-800/50 text-left group" onclick="shop.buy('fireRate')">
                    <div class="text-cyan-400 font-bold mb-1">REFRIGERA√á√ÉO</div>
                    <div class="text-xs text-gray-400">Velocidade +</div>
                    <div class="flex justify-between mt-2"><span id="lvl-fireRate" class="text-gray-500">1</span> <span id="cost-fireRate" class="text-yellow-400">150</span></div>
                    <div class="h-1 bg-gray-700 mt-2"><div id="bar-fireRate" class="h-full bg-cyan-500 w-[10%]"></div></div>
                </button>
                <button id="btnMulti" class="shop-card p-4 rounded bg-gray-800/50 text-left group" onclick="shop.buy('multishot')">
                    <div class="text-purple-400 font-bold mb-1">MULTI-CANH√ÉO</div>
                    <div class="text-xs text-gray-400">Proj√©teis +</div>
                    <div class="flex justify-between mt-2"><span id="lvl-multishot" class="text-gray-500">0</span> <span id="cost-multishot" class="text-yellow-400">500</span></div>
                    <div class="h-1 bg-gray-700 mt-2"><div id="bar-multishot" class="h-full bg-purple-500 w-[0%]"></div></div>
                </button>
                <button id="btnHeal" class="shop-card p-4 rounded bg-gray-800/50 text-left group border border-green-900/50" onclick="shop.buy('heal')">
                    <div class="text-green-400 font-bold mb-1">REPARO</div>
                    <div class="text-xs text-gray-400">Cura 50%</div>
                    <div class="text-yellow-400 font-bold mt-2">50</div>
                </button>
                
                <!-- Bot√£o Laser -->
                <button id="btnLaser" class="shop-card p-4 rounded bg-gray-800/50 text-left group border border-cyan-400 box-shadow-cyan" onclick="shop.buy('laser')">
                    <div class="text-white font-bold mb-1 text-shadow-cyan">LASER ORBITAL</div>
                    <div class="text-xs text-gray-400">Raio perfurante (35s)</div>
                    <div class="flex justify-between mt-2">
                        <span class="text-gray-500">TEMPOR√ÅRIO</span> 
                        <span id="cost-laser" class="text-yellow-400">450</span>
                    </div>
                </button>

                <!-- Bot√£o Nuke -->
                <button id="btnNuke" class="shop-card p-4 rounded bg-gray-800/50 text-left group border border-orange-500 shadow-[0_0_15px_rgba(255,165,0,0.3)]" onclick="shop.buy('nuke')">
                    <div class="text-orange-500 font-bold mb-1">BOMBA N√äUTRONS</div>
                    <div class="text-xs text-gray-400">Destr√≥i TODOS os inimigos.</div>
                    <div class="flex justify-between mt-2">
                        <span class="text-gray-500">INSTANT√ÇNEO</span> 
                        <span id="cost-nuke" class="text-yellow-400">900</span>
                    </div>
                </button>
                
                <!-- Bot√£o Escudo Tempor√°rio -->
                <button id="btnShield" class="shop-card p-4 rounded bg-gray-800/50 text-left group border border-blue-500" onclick="shop.buy('shield')">
                    <div class="text-blue-400 font-bold mb-1">ESCUDO TEMPOR√ÅRIO</div>
                    <div class="text-xs text-gray-400">Invencibilidade por 10s</div>
                    <div class="flex justify-between mt-2">
                        <span class="text-gray-500">TEMPOR√ÅRIO</span> 
                        <span id="cost-shield" class="text-yellow-400">300</span>
                    </div>
                </button>
            </div>
            <div class="mt-8 text-center">
                <button onclick="toggleShop()" class="px-8 py-2 bg-red-600 hover:bg-red-500 text-white rounded font-bold uppercase text-sm tracking-wider">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Game Over Screen -->
    <div id="gameOverScreen" class="absolute inset-0 z-40 bg-black/90 hidden flex flex-col items-center justify-center">
        <h2 class="text-6xl font-bold text-red-500 mb-4 retro-glitch">SISTEMA CR√çTICO</h2>
        <div class="glass-panel p-8 rounded-lg text-center mb-8 w-96">
            <div class="flex justify-between mb-2">
                <span class="text-gray-400">Pontua√ß√£o</span>
                <span id="finalScore" class="text-white font-bold">0</span>
            </div>
            <div class="flex justify-between mb-4">
                <span class="text-gray-400">Ondas</span>
                <span id="finalWave" class="text-white font-bold">0</span>
            </div>
            <div class="border-t border-gray-700 pt-4 flex justify-between items-center">
                <span class="text-cyan-400 font-bold">DIAMANTES GANHOS</span>
                <span id="finalDiamonds" class="text-3xl font-bold diamond-text drop-shadow-[0_0_10px_#00f3ff]">+0</span>
            </div>
        </div>
        <button onclick="authManager.returnToMenu()" class="btn-cyber bg-white text-black font-bold py-3 px-8 text-lg">
            VOLTAR AO MENU
        </button>
    </div>

    <!-- Popup de Conquistas -->
    <div id="achievementPopup" class="achievement-popup">
        <div class="flex items-center gap-3">
            <div class="text-yellow-400 text-2xl">üèÜ</div>
            <div>
                <div class="text-yellow-400 font-bold text-sm">CONQUISTA DESBLOQUEADA!</div>
                <div id="achievementTitle" class="text-white text-xs"></div>
            </div>
        </div>
    </div>

    <div id="gameContainer" class="relative">
        <canvas id="gameCanvas" width="1024" height="768"></canvas>
    </div>

    <script>
        // ==========================================
        // CONFIGURA√á√ÉO FIREBASE
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCBv_7DsUDPva451ZTwN0qxZ9r624T_NBc",
            authDomain: "navesa-bb3be.firebaseapp.com",
            projectId: "navesa-bb3be",
            storageBucket: "navesa-bb3be.firebasestorage.app",
            messagingSenderId: "969086896980",
            appId: "1:969086896980:web:89eb7347d2f60d9fe1d6c1"
        };
        
        const isFirebaseConfigured = firebaseConfig.apiKey !== "SUA_API_KEY_AQUI";
        let db, auth;

        if (isFirebaseConfigured) {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
        } else {
            console.log("Firebase n√£o configurado. Usando modo Offline/Simula√ß√£o.");
        }

        // Vari√°veis globais para novas funcionalidades
        let selectedShip = 'basic';
        let powerups = [];
        let activePowerups = {};
        let missions = [];
        let currentMission = null;
        let missionProgress = 0;
        let achievements = {};
        let enemiesKilled = 0;
        let totalCoinsCollected = 0;
        let totalPlayTime = 0;
        let gameStartTime = 0;

        const authManager = {
            user: null,
            data: {
                diamonds: 0,
                highScore: 0,
                upgrades: { 
                    shield: false, 
                    magnet: false, 
                    dash: false, 
                    rapidFire: false, 
                    greed: false,
                    powerup: false
                },
                achievements: {},
                ships: { basic: true, tank: false, speed: false },
                stats: {
                    enemiesKilled: 0,
                    totalCoins: 0,
                    totalPlayTime: 0,
                    missionsCompleted: 0
                }
            },
            isRegistering: false,

            // --- UI Logic ---
            toggleRegisterMode: function() {
                this.isRegistering = !this.isRegistering;
                const regInput = document.getElementById('regName');
                const btnToggle = document.getElementById('btnToggleReg');
                const btnConfirm = document.getElementById('btnConfirmReg');
                const status = document.getElementById('loginStatus');

                if(this.isRegistering) {
                    regInput.classList.remove('hidden');
                    btnConfirm.classList.remove('hidden');
                    btnToggle.innerText = "CANCELAR";
                    status.innerText = "Preencha os dados para criar conta.";
                    status.classList.remove('text-red-400'); status.classList.add('text-cyan-400');
                } else {
                    regInput.classList.add('hidden');
                    btnConfirm.classList.add('hidden');
                    btnToggle.innerText = "CRIAR CONTA";
                    status.innerText = "";
                }
            },

            // --- LOGIN AN√îNIMO (NOVO) ---
            loginAnonymous: function() {
                if (!isFirebaseConfigured) { this.mockLogin(); return; }
                
                const status = document.getElementById('loginStatus');
                status.innerText = "Autenticando anonimamente...";
                status.classList.remove('text-red-400'); status.classList.add('text-yellow-400');

                auth.signInAnonymously()
                    .then((result) => {
                        this.user = result.user;
                        this.loadData();
                        this.showMenu();
                    })
                    .catch((error) => {
                        status.classList.add('text-red-400');
                        status.innerText = "Erro An√¥nimo: " + error.message;
                    });
            },

            // --- LOGIN EMAIL ---
            loginEmail: function() {
                const email = document.getElementById('emailInput').value;
                const pass = document.getElementById('passInput').value;
                const status = document.getElementById('loginStatus');

                if(!email || !pass) { status.innerText = "Preencha email e senha."; return; }

                auth.signInWithEmailAndPassword(email, pass)
                    .then((result) => {
                        this.user = result.user;
                        this.loadData();
                        this.showMenu();
                    })
                    .catch((error) => {
                        status.classList.add('text-red-400');
                        status.innerText = "Erro: " + error.message;
                    });
            },

            // --- REGISTRO EMAIL ---
            registerEmail: function() {
                const email = document.getElementById('emailInput').value;
                const pass = document.getElementById('passInput').value;
                const name = document.getElementById('regName').value;
                const status = document.getElementById('loginStatus');

                if(!email || !pass || !name) { status.innerText = "Preencha todos os campos."; return; }

                auth.createUserWithEmailAndPassword(email, pass)
                    .then((result) => {
                        const user = result.user;
                        user.updateProfile({ displayName: name }).then(() => {
                            this.user = user;
                            this.saveData(); 
                            this.showMenu();
                        });
                    })
                    .catch((error) => {
                        status.classList.add('text-red-400');
                        status.innerText = "Erro: " + error.message;
                    });
            },

            // --- GOOGLE LOGIN ---
            loginGoogle: function() {
                if (!isFirebaseConfigured) { this.mockLogin(); return; }
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider)
                    .then((result) => {
                        this.user = result.user;
                        this.loadData();
                        this.showMenu();
                    })
                    .catch((error) => {
                        document.getElementById('loginStatus').innerText = error.message;
                    });
            },

            // Mock para testes offline
            mockLogin: function() {
                this.user = { displayName: "Viajante Offline", uid: "offline_user" };
                const localData = localStorage.getItem('neonVoidData');
                if(localData) this.data = JSON.parse(localData);
                this.showMenu();
            },

            showMenu: function() {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainMenu').style.display = 'flex';
                document.getElementById('mainMenu').classList.remove('hidden');
                
                if(this.user) {
                    // Se for an√¥nimo, displayName √© null. Criamos um nome visual.
                    let dName = this.user.displayName;
                    if(!dName) dName = "An√¥nimo-" + this.user.uid.substring(0, 5);

                    document.getElementById('userName').innerText = "Cmd. " + dName;
                    document.getElementById('diamondDisplay').innerText = this.data.diamonds;
                }
                permShop.updateUI();
                updateAchievementsUI();
            },

            // --- FIRESTORE DATA ---
            loadData: function() {
                if(!this.user || !isFirebaseConfigured) return;
                
                db.collection('users').doc(this.user.uid).get().then((doc) => {
                    if (doc.exists) {
                        this.data = doc.data();
                        // Retrocompatibilidade
                        if(this.data.highScore === undefined) this.data.highScore = 0;
                        if(!this.data.upgrades) this.data.upgrades = {};
                        if(!this.data.achievements) this.data.achievements = {};
                        if(!this.data.ships) this.data.ships = { basic: true };
                        if(!this.data.stats) this.data.stats = {
                            enemiesKilled: 0,
                            totalCoins: 0,
                            totalPlayTime: 0,
                            missionsCompleted: 0
                        };
                        
                        document.getElementById('diamondDisplay').innerText = this.data.diamonds;
                        permShop.updateUI();
                        updateAchievementsUI();
                    } else {
                        this.saveData(); // Cria documento para usu√°rio novo/an√¥nimo
                    }
                });
            },

            saveData: function() {
                if(!this.user) return;
                
                // Define um nome para salvar no banco se o usu√°rio for an√¥nimo
                let saveName = this.user.displayName;
                if(!saveName) saveName = "An√¥nimo-" + this.user.uid.substring(0, 5);

                const payload = {
                    diamonds: this.data.diamonds,
                    highScore: this.data.highScore || 0,
                    upgrades: this.data.upgrades,
                    achievements: this.data.achievements,
                    ships: this.data.ships,
                    stats: this.data.stats,
                    name: saveName, 
                    email: this.user.email || "anonymous"
                };

                if(isFirebaseConfigured) {
                    db.collection('users').doc(this.user.uid).set(payload, { merge: true });
                } else {
                    localStorage.setItem('neonVoidData', JSON.stringify(this.data));
                }
                document.getElementById('diamondDisplay').innerText = this.data.diamonds;
            },

            addDiamonds: function(amount) {
                if(!this.user) return;
                this.data.diamonds += amount;
                this.saveData();
            },
            
            returnToMenu: function() {
                // Atualizar estat√≠sticas
                if(gameStartTime > 0) {
                    this.data.stats.totalPlayTime += (Date.now() - gameStartTime);
                    gameStartTime = 0;
                }
                
                this.saveData();
                
                document.getElementById('gameOverScreen').style.display = 'none';
                document.getElementById('mainMenu').style.display = 'flex';
                this.showMenu();
            },
            
            unlockAchievement: function(id) {
                if(!this.data.achievements[id]) {
                    this.data.achievements[id] = true;
                    this.saveData();
                    showAchievementPopup(id);
                    return true;
                }
                return false;
            }
        };

        // --- L√≥gica do Hangar (Loja Permanente) ---
        const permShop = {
            costs: {
                shield: 10,
                magnet: 25,
                dash: 50,
                rapidFire: 60,
                greed: 40,
                powerup: 35
            },
            
            updateUI: function() {
                document.getElementById('hangarDiamonds').innerText = authManager.data.diamonds;
                ['shield', 'magnet', 'dash', 'rapidFire', 'greed', 'powerup'].forEach(key => this.updateButton(key));
            },
            
            updateButton: function(key) {
                const btn = document.getElementById(`perm${key.charAt(0).toUpperCase() + key.slice(1)}`);
                const status = document.getElementById(`status-${key}`);
                const unlocked = authManager.data.upgrades[key];
                
                if(unlocked) {
                    status.innerText = "INSTALADO";
                    status.classList.remove('bg-gray-700');
                    status.classList.add('bg-green-600', 'text-white');
                    btn.classList.add('border-green-500');
                    btn.disabled = true;
                    btn.style.opacity = "1";
                } else {
                    status.innerText = "BLOQUEADO";
                    status.classList.add('bg-gray-700');
                    status.classList.remove('bg-green-600');
                    btn.disabled = authManager.data.diamonds < this.costs[key];
                }
            },

            buy: function(key) {
                const cost = this.costs[key];
                if(authManager.data.diamonds >= cost && !authManager.data.upgrades[key]) {
                    authManager.data.diamonds -= cost;
                    authManager.data.upgrades[key] = true;
                    authManager.saveData();
                    this.updateUI();
                    alert(`Upgrade ${key.toUpperCase()} instalado!`);
                }
            }
        };

        function toggleHangar() {
            const el = document.getElementById('hangarModal');
            if(el.style.display === 'flex') el.style.display = 'none';
            else {
                el.style.display = 'flex';
                permShop.updateUI();
            }
        }

        // --- Sistema de Sele√ß√£o de Naves ---
        function showShipSelection() {
            document.getElementById('shipSelectionModal').style.display = 'flex';
            updateShipSelectionUI();
        }
        
        function hideShipSelection() {
            document.getElementById('shipSelectionModal').style.display = 'none';
        }
        
        function selectShip(shipType) {
            if(!authManager.data.ships[shipType]) {
                alert("Esta nave ainda n√£o est√° dispon√≠vel. Desbloqueie-a completando conquistas!");
                return;
            }
            
            selectedShip = shipType;
            updateShipSelectionUI();
        }
        
        function updateShipSelectionUI() {
            // Remover sele√ß√£o de todas as naves
            document.querySelectorAll('.ship-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Adicionar sele√ß√£o √† nave atual
            document.getElementById(`ship-${selectedShip}`).classList.add('selected');
            
            // Atualizar status de desbloqueio
            Object.keys(authManager.data.ships).forEach(shipType => {
                const shipElement = document.getElementById(`ship-${shipType}`);
                if(!authManager.data.ships[shipType]) {
                    shipElement.style.opacity = "0.6";
                    shipElement.style.cursor = "not-allowed";
                } else {
                    shipElement.style.opacity = "1";
                    shipElement.style.cursor = "pointer";
                }
            });
        }

        // --- Sistema de Conquistas ---
        function showAchievements() {
            document.getElementById('achievementsModal').style.display = 'flex';
            updateAchievementsUI();
        }
        
        function hideAchievements() {
            document.getElementById('achievementsModal').style.display = 'none';
        }
        
        function updateAchievementsUI() {
            const container = document.querySelector('#achievementsModal .grid');
            if(!container) return;
            
            const achievementsList = [
                { id: 'first_blood', title: 'Primeiro Sangue', description: 'Destrua seu primeiro inimigo', reward: 5 },
                { id: 'coin_collector', title: 'Colecionador de Moedas', description: 'Colete 1000 moedas no total', reward: 10 },
                { id: 'wave_master', title: 'Mestre das Ondas', description: 'Alcance a onda 10', reward: 15 },
                { id: 'untouchable', title: 'Intoc√°vel', description: 'Complete uma onda sem tomar dano', reward: 20 },
                { id: 'shopping_spree', title: 'Comprador Compulsivo', description: 'Compre todos os upgrades de uma sess√£o', reward: 25 },
                { id: 'veteran', title: 'Veterano', description: 'Jogue por mais de 1 hora no total', reward: 30 },
                { id: 'unlock_tank', title: 'Tanque de Guerra', description: 'Destrua 500 inimigos no total', reward: 0, ship: 'tank' },
                { id: 'unlock_speed', title: 'Velocista', description: 'Colete 5000 moedas no total', reward: 0, ship: 'speed' }
            ];
            
            let html = '';
            achievementsList.forEach(ach => {
                const unlocked = authManager.data.achievements[ach.id] || false;
                
                html += `
                <div class="p-4 rounded bg-gray-800/50 border ${unlocked ? 'border-green-500' : 'border-gray-700'}">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold ${unlocked ? 'text-green-400' : 'text-gray-400'}">${ach.title}</div>
                            <div class="text-sm text-gray-400 mt-1">${ach.description}</div>
                        </div>
                        <div class="text-right">
                            ${unlocked ? 
                                '<span class="text-green-400 text-sm">DESBLOQUEADA</span>' : 
                                `<span class="text-yellow-400 text-sm">+${ach.reward} ‚ô¶</span>`
                            }
                        </div>
                    </div>
                    ${!unlocked && ach.ship ? 
                        `<div class="mt-2 text-xs text-cyan-400">Recompensa: Desbloqueia a nave ${ach.ship.toUpperCase()}</div>` : 
                        ''
                    }
                </div>`;
            });
            
            container.innerHTML = html;
        }
        
        function showAchievementPopup(achievementId) {
            const achievementsList = {
                'first_blood': { title: 'Primeiro Sangue' },
                'coin_collector': { title: 'Colecionador de Moedas' },
                'wave_master': { title: 'Mestre das Ondas' },
                'untouchable': { title: 'Intoc√°vel' },
                'shopping_spree': { title: 'Comprador Compulsivo' },
                'veteran': { title: 'Veterano' },
                'unlock_tank': { title: 'Tanque de Guerra' },
                'unlock_speed': { title: 'Velocista' }
            };
            
            const achievement = achievementsList[achievementId];
            if(!achievement) return;
            
            const popup = document.getElementById('achievementPopup');
            document.getElementById('achievementTitle').innerText = achievement.title;
            
            popup.classList.add('show');
            
            setTimeout(() => {
                popup.classList.remove('show');
            }, 3000);
        }

        // --- Sistema de Miss√µes ---
        function generateMission() {
            const missionTypes = [
                { type: 'kill', target: 10 + Math.floor(wave * 2), text: `Destrua ${10 + Math.floor(wave * 2)} inimigos` },
                { type: 'collect', target: 200 + (wave * 50), text: `Colete ${200 + (wave * 50)} moedas` },
                { type: 'survive', target: 120, text: `Sobreviva por 2 minutos` }
            ];
            
            return missionTypes[Math.floor(Math.random() * missionTypes.length)];
        }
        
        function updateMissionProgress() {
            if(!currentMission) return;
            
            let progress = 0;
            switch(currentMission.type) {
                case 'kill':
                    progress = enemiesKilled;
                    break;
                case 'collect':
                    progress = totalCoinsCollected;
                    break;
                case 'survive':
                    progress = Math.floor((Date.now() - gameStartTime) / 1000);
                    break;
            }
            
            missionProgress = progress;
            const percent = Math.min(100, (progress / currentMission.target) * 100);
            
            document.getElementById('missionProgress').style.width = `${percent}%`;
            document.getElementById('missionProgressText').innerText = `${progress}/${currentMission.target}`;
            
            // Verificar se a miss√£o foi completada
            if(progress >= currentMission.target) {
                completeMission();
            }
        }
        
        function completeMission() {
            if(!currentMission) return;
            
            // Recompensa por completar miss√£o
            const reward = 100 + (wave * 20);
            player.coins += reward;
            
            // Mostrar notifica√ß√£o
            createFloatingText(player.x, player.y, `Miss√£o Completa! +${reward}`, '#00ff00');
            
            // Atualizar estat√≠sticas
            authManager.data.stats.missionsCompleted++;
            
            // Gerar nova miss√£o
            currentMission = generateMission();
            missionProgress = 0;
            
            // Atualizar UI
            document.getElementById('missionText').innerText = currentMission.text;
            document.getElementById('missionProgress').style.width = '0%';
            document.getElementById('missionProgressText').innerText = `0/${currentMission.target}`;
        }

        // --- Sistema de Power-ups ---
        class Powerup {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.radius = 8;
                this.life = 600;
                
                // Definir cores e efeitos baseados no tipo
                switch(type) {
                    case 'health':
                        this.color = '#00ff00';
                        this.glow = '#00ff00';
                        break;
                    case 'speed':
                        this.color = '#00ffff';
                        this.glow = '#00ffff';
                        break;
                    case 'damage':
                        this.color = '#ff0000';
                        this.glow = '#ff0000';
                        break;
                    case 'shield':
                        this.color = '#0000ff';
                        this.glow = '#0000ff';
                        break;
                }
            }
            
            update() {
                this.life--;
                
                // Movimento em dire√ß√£o ao jogador (mais lento que moedas)
                const dist = Math.hypot(player.x - this.x, player.y - this.y);
                if(dist < player.magnetRange) {
                    this.x += (player.x - this.x) * 0.05;
                    this.y += (player.y - this.y) * 0.05;
                }
            }
            
            draw() {
                ctx.save();
                
                // Efeito de brilho
                ctx.shadowBlur = 15;
                ctx.shadowColor = this.glow;
                
                // Desenhar power-up
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // S√≠mbolo interno baseado no tipo
                ctx.fillStyle = '#000';
                ctx.shadowBlur = 0;
                
                switch(this.type) {
                    case 'health':
                        // Cruz
                        ctx.fillRect(this.x - 2, this.y - 5, 4, 10);
                        ctx.fillRect(this.x - 5, this.y - 2, 10, 4);
                        break;
                    case 'speed':
                        // Raio
                        ctx.beginPath();
                        ctx.moveTo(this.x - 4, this.y + 3);
                        ctx.lineTo(this.x, this.y - 4);
                        ctx.lineTo(this.x + 4, this.y + 3);
                        ctx.lineTo(this.x, this.y - 1);
                        ctx.closePath();
                        ctx.fill();
                        break;
                    case 'damage':
                        // Estrela
                        ctx.beginPath();
                        for(let i = 0; i < 5; i++) {
                            const angle = (i * 2 * Math.PI / 5) - Math.PI / 2;
                            const x = this.x + Math.cos(angle) * 4;
                            const y = this.y + Math.sin(angle) * 4;
                            if(i === 0) ctx.moveTo(x, y);
                            else ctx.lineTo(x, y);
                        }
                        ctx.closePath();
                        ctx.fill();
                        break;
                    case 'shield':
                        // Escudo
                        ctx.beginPath();
                        ctx.arc(this.x, this.y, 4, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.fillStyle = this.color;
                        ctx.beginPath();
                        ctx.arc(this.x, this.y, 2, 0, Math.PI * 2);
                        ctx.fill();
                        break;
                }
                
                ctx.restore();
            }
            
            apply() {
                switch(this.type) {
                    case 'health':
                        player.hp = Math.min(player.maxHp, player.hp + 30);
                        createFloatingText(player.x, player.y, '+30 HP', '#00ff00');
                        break;
                    case 'speed':
                        activePowerups.speed = 300; // 5 segundos a 60 FPS
                        player.speed *= 1.5;
                        createFloatingText(player.x, player.y, 'VELOCIDADE AUMENTADA', '#00ffff');
                        break;
                    case 'damage':
                        activePowerups.damage = 300;
                        player.damage *= 1.5;
                        createFloatingText(player.x, player.y, 'DANO AUMENTADO', '#ff0000');
                        break;
                    case 'shield':
                        activePowerups.shield = 300;
                        player.invulnerable = true;
                        createFloatingText(player.x, player.y, 'ESCUDO ATIVADO', '#0000ff');
                        break;
                }
                
                updatePowerupIndicators();
            }
        }
        
        function updatePowerups() {
            // Atualizar power-ups ativos
            Object.keys(activePowerups).forEach(key => {
                if(activePowerups[key] > 0) {
                    activePowerups[key]--;
                    
                    // Quando o power-up expira
                    if(activePowerups[key] <= 0) {
                        switch(key) {
                            case 'speed':
                                player.speed /= 1.5;
                                break;
                            case 'damage':
                                player.damage /= 1.5;
                                break;
                            case 'shield':
                                player.invulnerable = false;
                                break;
                        }
                        delete activePowerups[key];
                        updatePowerupIndicators();
                    }
                }
            });
            
            // Atualizar power-ups no mapa
            powerups.forEach((p, i) => {
                p.update();
                p.draw();
                
                // Verificar colis√£o com o jogador
                const dist = Math.hypot(player.x - p.x, player.y - p.y);
                if(dist < player.radius + p.radius) {
                    p.apply();
                    powerups.splice(i, 1);
                }
                
                // Remover se expirou
                if(p.life <= 0) {
                    powerups.splice(i, 1);
                }
            });
        }
        
        function updatePowerupIndicators() {
            const container = document.getElementById('powerupIndicators');
            container.innerHTML = '';
            
            Object.keys(activePowerups).forEach(key => {
                const timeLeft = Math.ceil(activePowerups[key] / 60);
                let text, color;
                
                switch(key) {
                    case 'speed':
                        text = `VELOCIDADE (${timeLeft}s)`;
                        color = 'text-cyan-400';
                        break;
                    case 'damage':
                        text = `DANO (${timeLeft}s)`;
                        color = 'text-red-400';
                        break;
                    case 'shield':
                        text = `ESCUDO (${timeLeft}s)`;
                        color = 'text-blue-400';
                        break;
                }
                
                const indicator = document.createElement('div');
                indicator.className = `text-xs ${color} font-bold`;
                indicator.innerText = text;
                container.appendChild(indicator);
            });
        }
        
        function createFloatingText(x, y, text, color) {
            // Criar elemento de texto flutuante
            const floatingText = document.createElement('div');
            floatingText.innerText = text;
            floatingText.style.position = 'absolute';
            floatingText.style.left = `${x}px`;
            floatingText.style.top = `${y}px`;
            floatingText.style.color = color;
            floatingText.style.fontWeight = 'bold';
            floatingText.style.textShadow = `0 0 5px ${color}`;
            floatingText.style.pointerEvents = 'none';
            floatingText.style.zIndex = '100';
            floatingText.style.transition = 'all 1s ease-out';
            floatingText.style.transform = 'translate(-50%, -50%)';
            
            document.getElementById('gameContainer').appendChild(floatingText);
            
            // Anima√ß√£o
            setTimeout(() => {
                floatingText.style.top = `${y - 50}px`;
                floatingText.style.opacity = '0';
            }, 10);
            
            // Remover ap√≥s anima√ß√£o
            setTimeout(() => {
                document.getElementById('gameContainer').removeChild(floatingText);
            }, 1000);
        }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const keys = { w: false, a: false, s: false, d: false, space: false, shift: false };
        const mouse = { x: 0, y: 0, down: false };
        
        let player, projectiles, enemies, particles, coins;
        let isPlaying = false;
        let isShopOpen = false;
        let wave = 1;

        // --- Classes do Jogo ---
        class Player {
            constructor() {
                // Configura√ß√µes baseadas na nave selecionada
                switch(selectedShip) {
                    case 'basic':
                        this.maxHp = 100;
                        this.speed = 4;
                        this.damage = 10;
                        this.fireDelay = 25;
                        break;
                    case 'tank':
                        this.maxHp = 150;
                        this.speed = 3;
                        this.damage = 15;
                        this.fireDelay = 30;
                        break;
                    case 'speed':
                        this.maxHp = 80;
                        this.speed = 6;
                        this.damage = 8;
                        this.fireDelay = 15;
                        break;
                }
                
                this.x = canvas.width / 2;
                this.y = canvas.height / 2;
                this.radius = 20;
                this.angle = 0;
                this.laserTimer = 0; // Timer do Laser Orbital
                this.shieldTimer = 0; // Timer do Escudo Tempor√°rio
                
                // UPGRADE: Escudo
                if(authManager.data.upgrades.shield) {
                    this.maxHp = Math.floor(this.maxHp * 1.5);
                }
                
                this.hp = this.maxHp;
                this.score = 0;
                
                // UPGRADE: Greed
                this.coins = authManager.data.upgrades.greed ? 500 : 0;
                
                // Combate
                this.multishot = 0;
                this.lastShot = 0;

                // UPGRADE: Magneto
                this.magnetRange = authManager.data.upgrades.magnet ? 150 : 50;

                // UPGRADE: Dash
                this.canDash = authManager.data.upgrades.dash;
                this.isDashing = false;
                this.dashCooldown = 0;
                this.dashMaxCooldown = 120;
                this.dashDuration = 10;
                this.invulnerable = false;
                
                // UPGRADE: Rapid Fire
                if(authManager.data.upgrades.rapidFire) {
                    this.fireDelay = Math.max(5, this.fireDelay - 7);
                }
            }

            update() {
                // Dash Logic
                if(this.dashCooldown > 0) this.dashCooldown--;
                
                if(this.canDash && keys.shift && this.dashCooldown <= 0 && !this.isDashing) {
                    this.isDashing = true;
                    this.dashCooldown = this.dashMaxCooldown;
                    this.invulnerable = true;
                    createExplosion(this.x, this.y, '#00ff9d', 5);
                }

                let currentSpeed = this.speed;
                if(this.isDashing) {
                    currentSpeed *= 4;
                    this.dashDuration--;
                    createExplosion(this.x, this.y, '#00ff9d', 1);
                    if(this.dashDuration <= 0) {
                        this.isDashing = false;
                        this.invulnerable = false;
                        this.dashDuration = 10;
                    }
                }

                // Movimento
                if (keys.w && this.y > this.radius) this.y -= currentSpeed;
                if (keys.s && this.y < canvas.height - this.radius) this.y += currentSpeed;
                if (keys.a && this.x > this.radius) this.x -= currentSpeed;
                if (keys.d && this.x < canvas.width - this.radius) this.x += currentSpeed;

                this.angle = Math.atan2(mouse.y - this.y, mouse.x - this.x);

                // Tiro (Bloqueado se o Laser estiver ativo)
                this.lastShot++;
                if (mouse.down && this.lastShot >= this.fireDelay && !this.isDashing && this.laserTimer <= 0) {
                    this.shoot();
                    this.lastShot = 0;
                }
                
                // Atualizar escudo tempor√°rio
                if(this.shieldTimer > 0) {
                    this.shieldTimer--;
                    if(this.shieldTimer <= 0) {
                        this.invulnerable = false;
                    }
                }
            }

            shoot() {
                projectiles.push(new Projectile(this.x, this.y, this.angle, this.damage));
                if(this.multishot > 0) {
                    const spread = 0.2;
                    for(let i=1; i <= this.multishot; i++) {
                        const alt = i % 2 === 0 ? 1 : -1;
                        const mult = Math.ceil(i/2);
                        projectiles.push(new Projectile(this.x, this.y, this.angle + (spread * mult * alt), this.damage));
                    }
                }
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);
                
                // Dash Visual
                if(this.invulnerable) {
                    ctx.shadowBlur = 20;
                    ctx.shadowColor = this.shieldTimer > 0 ? '#0000ff' : '#00ff9d';
                    ctx.strokeStyle = '#ffffff';
                } else {
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = '#00f3ff';
                    ctx.strokeStyle = '#00f3ff';
                }

                // Desenho da nave baseado no tipo
                ctx.beginPath();
                
                switch(selectedShip) {
                    case 'basic':
                        ctx.moveTo(20, 0);
                        ctx.lineTo(-15, -15);
                        ctx.lineTo(-10, 0);
                        ctx.lineTo(-15, 15);
                        break;
                    case 'tank':
                        ctx.moveTo(15, 0);
                        ctx.lineTo(-20, -12);
                        ctx.lineTo(-20, 12);
                        ctx.closePath();
                        break;
                    case 'speed':
                        ctx.moveTo(25, 0);
                        ctx.lineTo(-10, -10);
                        ctx.lineTo(-5, 0);
                        ctx.lineTo(-10, 10);
                        break;
                }
                
                ctx.closePath();
                ctx.fillStyle = this.invulnerable ? '#ccffee' : '#0a0a10';
                ctx.fill();
                ctx.lineWidth = 2;
                ctx.stroke();

                // Escudo Visual
                if(authManager.data.upgrades.shield && this.hp > this.maxHp * 0.66) {
                    ctx.beginPath();
                    ctx.arc(0, 0, 30, 0, Math.PI*2);
                    ctx.strokeStyle = `rgba(0, 100, 255, ${ (this.hp - (this.maxHp * 0.66)) / (this.maxHp * 0.33) })`;
                    ctx.stroke();
                }
                
                // Escudo tempor√°rio visual
                if(this.shieldTimer > 0) {
                    ctx.beginPath();
                    ctx.arc(0, 0, 35, 0, Math.PI*2);
                    ctx.strokeStyle = `rgba(0, 150, 255, 0.7)`;
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }

                ctx.restore();
            }
        }

        class Projectile {
            constructor(x, y, angle, damage) {
                this.x = x; this.y = y;
                this.velocity = { x: Math.cos(angle) * 10, y: Math.sin(angle) * 10 };
                this.damage = damage; this.radius = 4;
            }
            update() { this.x += this.velocity.x; this.y += this.velocity.y; }
            draw() {
                ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = '#ffff00'; ctx.fill();
                ctx.shadowBlur = 10; ctx.shadowColor = '#ffff00';
            }
        }

        class Enemy {
            constructor(type, diff) {
                if (Math.random() < 0.5) {
                    this.x = Math.random() < 0.5 ? -30 : canvas.width + 30;
                    this.y = Math.random() * canvas.height;
                } else {
                    this.x = Math.random() * canvas.width;
                    this.y = Math.random() < 0.5 ? -30 : canvas.height + 30;
                }
                this.type = type;
                
                if(type === 0) { // Basic
                    this.radius = 20; this.color = '#ff00ff'; this.speed = 1.5 + Math.random();
                    this.hp = 30 * diff; this.value = 5;
                } else if (type === 1) { // Tank
                    this.radius = 35; this.color = '#ff5500'; this.speed = 0.8;
                    this.hp = 80 * diff; this.value = 15;
                } else if (type === 2) { // Rusher
                    this.radius = 12; this.color = '#00ff00'; this.speed = 3.5;
                    this.hp = 15 * diff; this.value = 8;
                } else if (type === 3) { // Seeker (Blue)
                    this.radius = 25; this.color = '#00ffff'; this.speed = 2.2;
                    this.hp = 60 * diff; this.value = 20;
                } else if (type === 4) { // Goliath (Red Boss)
                    this.radius = 55; this.color = '#8b0000'; this.speed = 0.4;
                    this.hp = 300 * diff; this.value = 100;
                } else if (type === 5) { // Wasp (Yellow Fast)
                    this.radius = 8; this.color = '#ffffaa'; this.speed = 5.5;
                    this.hp = 10 * diff; this.value = 25;
                } else if (type === 6) { // Shooter (Purple)
                    this.radius = 18; this.color = '#aa00ff'; this.speed = 1.2;
                    this.hp = 40 * diff; this.value = 30;
                    this.shootTimer = 0;
                    this.shootDelay = 120; // Atira a cada 2 segundos
                }
                this.maxHp = this.hp;
            }
            update() {
                const angle = Math.atan2(player.y - this.y, player.x - this.x);
                this.x += Math.cos(angle) * this.speed;
                this.y += Math.sin(angle) * this.speed;
                
                // L√≥gica de tiro para inimigos atiradores
                if(this.type === 6) {
                    this.shootTimer++;
                    if(this.shootTimer >= this.shootDelay) {
                        this.shoot();
                        this.shootTimer = 0;
                    }
                }
            }
            
            shoot() {
                const angle = Math.atan2(player.y - this.y, player.x - this.x);
                projectiles.push(new EnemyProjectile(this.x, this.y, angle, 5));
            }
            
            draw() {
                ctx.save(); ctx.translate(this.x, this.y);
                
                // Desenho do Inimigo
                ctx.fillStyle = '#000'; ctx.strokeStyle = this.color; ctx.lineWidth = 2;
                ctx.shadowBlur = 10; ctx.shadowColor = this.color;
                ctx.beginPath(); ctx.arc(0, 0, this.radius, 0, Math.PI*2);
                ctx.fill(); ctx.stroke();
                
                // Desenho especial para atiradores
                if(this.type === 6) {
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(0, 0, this.radius * 0.6, 0, Math.PI*2);
                    ctx.fill();
                }

                // --- BARRA DE VIDA DO INIMIGO ---
                const barWidth = 30;
                const barHeight = 4;
                const yOffset = -this.radius - 12;
                const hpPercent = this.hp / this.maxHp;

                // Fundo da barra (Vermelho)
                ctx.fillStyle = '#550000';
                ctx.fillRect(-barWidth/2, yOffset, barWidth, barHeight);
                
                // Frente da barra (Verde)
                ctx.fillStyle = '#00ff00';
                ctx.fillRect(-barWidth/2, yOffset, barWidth * hpPercent, barHeight);
                // --------------------------------

                ctx.restore();
            }
        }
        
        class EnemyProjectile {
            constructor(x, y, angle, damage) {
                this.x = x; this.y = y;
                this.velocity = { x: Math.cos(angle) * 5, y: Math.sin(angle) * 5 };
                this.damage = damage; this.radius = 3;
            }
            update() { this.x += this.velocity.x; this.y += this.velocity.y; }
            draw() {
                ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = '#ff00ff'; ctx.fill();
                ctx.shadowBlur = 5; ctx.shadowColor = '#ff00ff';
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color;
                this.velocity = { x: (Math.random()-0.5)*8, y: (Math.random()-0.5)*8 };
                this.alpha = 1;
            }
            update() { this.x += this.velocity.x; this.y += this.velocity.y; this.alpha -= 0.05; }
            draw() {
                ctx.globalAlpha = this.alpha; ctx.fillStyle = this.color;
                ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI*2); ctx.fill();
                ctx.globalAlpha = 1;
            }
        }

        class Coin {
            constructor(x, y, val) {
                this.x = x; this.y = y; this.val = val;
                this.radius = 6;
                this.life = 600; 
            }
            update() {
                this.life--;
                const dist = Math.hypot(player.x - this.x, player.y - this.y);
                if(dist < player.magnetRange) {
                    this.x += (player.x - this.x) * 0.1;
                    this.y += (player.y - this.y) * 0.1;
                }
            }
            draw() {
                ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2);
                ctx.fillStyle = '#FFD700'; ctx.fill();
                ctx.strokeStyle = '#FFA500'; ctx.stroke();
            }
        }

        // --- Core Functions ---
        
        let difficultyMult = 1;
        let spawnTimer = 0;

        function initGame() {
            player = new Player();
            projectiles = [];
            enemies = [];
            particles = [];
            coins = [];
            powerups = [];
            activePowerups = {};
            wave = 1;
            difficultyMult = 1;
            enemiesKilled = 0;
            totalCoinsCollected = 0;
            gameStartTime = Date.now();
            
            // Gerar miss√£o inicial
            currentMission = generateMission();
            document.getElementById('missionText').innerText = currentMission.text;
            document.getElementById('missionProgress').style.width = '0%';
            document.getElementById('missionProgressText').innerText = `0/${currentMission.target}`;
            document.getElementById('missionTracker').classList.remove('hidden');
            
            shop.upgrades.damage.level = 1;
            shop.upgrades.fireRate.level = 1;
            shop.upgrades.multishot.level = 0;
            
            document.getElementById('dashIndicator').style.display = player.canDash ? 'flex' : 'none';
        }

        function startGame() {
            initGame();
            isPlaying = true;
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('shipSelectionModal').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('uiLayer').style.display = 'flex';
            document.getElementById('uiLayer').classList.remove('hidden');
            animate();
        }

        // --- SISTEMA DE √ÅUDIO (Sintetizador) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playBuySound() {
            // Retoma o contexto de √°udio se estiver suspenso (regra de navegadores)
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.type = 'triangle'; // Timbre estilo 8-bit
            
            // Efeito de subida de tom (Moeda)
            oscillator.frequency.setValueAtTime(1000, audioCtx.currentTime); 
            oscillator.frequency.exponentialRampToValueAtTime(2000, audioCtx.currentTime + 0.1);

            // Volume caindo
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.1);
        }

        const shop = {
            upgrades: {
                damage: { level: 1, max: 10, baseCost: 100, inc: 5 },
                fireRate: { level: 1, max: 8, baseCost: 150, inc: -2 },
                multishot: { level: 0, max: 4, baseCost: 500, inc: 1 }
            },
            buy: function(key) {
                if(key === 'heal') {
                    if(player.coins >= 50 && player.hp < player.maxHp) {
                        player.coins -= 50; player.hp = Math.min(player.hp + (player.maxHp*0.5), player.maxHp);
                        playBuySound()
                        this.updateUI();
                    }
                    return;
                }
                
                // Compra do Laser
                if(key === 'laser') {
                    const cost = 450;
                    if(player.coins >= cost) {
                        player.coins -= cost;
                        player.laserTimer = 2100; // 35 segundos (35 * 60 FPS)
                        playBuySound()
                        this.updateUI();
                        toggleShop();
                    }
                    return;
                }

                // Compra do Nuke
                if(key === 'nuke') {
                    const cost = 900;
                    if(player.coins >= cost) {
                        player.coins -= cost;
                        playBuySound()
                        // Explos√£o Central
                        createExplosion(canvas.width/2, canvas.height/2, '#ffaa00', 50);
                        
                        // Matar Todos
                        enemies.forEach(e => {
                            createExplosion(e.x, e.y, e.color, 15);
                            player.score += e.value * 10;
                            coins.push(new Coin(e.x, e.y, Math.floor(e.value * (1 + Math.random()))));
                        });
                        enemies = [];
                        
                        // Flash Branco
                        const oldFill = ctx.fillStyle;
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0,0, canvas.width, canvas.height);
                        ctx.fillStyle = oldFill;

                        this.updateUI();
                        toggleShop();
                    }
                    return;
                }
                
                // Compra do Escudo Tempor√°rio
                if(key === 'shield') {
                    const cost = 300;
                    if(player.coins >= cost) {
                        player.coins -= cost;
                        player.shieldTimer = 600; // 10 segundos
                        player.invulnerable = true;
                        playBuySound()
                        this.updateUI();
                        toggleShop();
                    }
                    return;
                }

                const item = this.upgrades[key];
                const cost = Math.floor(item.baseCost * Math.pow(1.5, item.level - (key === 'multishot'?0:1)));
                if(player.coins >= cost && item.level < item.max) {
                    player.coins -= cost; item.level++;
                    if(key === 'damage') player.damage += item.inc;
                    if(key === 'fireRate') player.fireDelay = Math.max(5, player.fireDelay + item.inc);
                    if(key === 'multishot') player.multishot += item.inc;
                    playBuySound()
                    this.updateUI();
                }
            },
            updateUI: function() {
                document.getElementById('shopCoins').innerText = player.coins;
                ['damage', 'fireRate', 'multishot'].forEach(k => {
                    const item = this.upgrades[k];
                    const cost = Math.floor(item.baseCost * Math.pow(1.5, item.level - (k === 'multishot'?0:1)));
                    const btn = document.getElementById(`btn${k==='fireRate'?'Spd':(k==='damage'?'Dmg':'Multi')}`);
                    document.getElementById(`lvl-${k}`).innerText = item.level;
                    document.getElementById(`cost-${k}`).innerText = item.level >= item.max ? "MAX" : cost;
                    document.getElementById(`bar-${k}`).style.width = `${(item.level/item.max)*100}%`;
                    btn.disabled = player.coins < cost || item.level >= item.max;
                });
            }
        };

        function toggleShop() {
            if(!isPlaying) return;
            isShopOpen = !isShopOpen;
            if(isShopOpen) {
                document.getElementById('shopModal').style.display = 'flex';
                shop.updateUI();
            } else {
                document.getElementById('shopModal').style.display = 'none';
                animate();
            }
        }

        function createExplosion(x, y, color, count) {
            for(let i=0; i<count; i++) particles.push(new Particle(x, y, color));
        }

        function updateHUD() {
            const hpP = Math.max(0, (player.hp / player.maxHp) * 100);
            document.getElementById('hpBar').style.width = `${hpP}%`;
            document.getElementById('hpBar').style.backgroundColor = hpP < 30 ? '#ff0000' : (hpP > 100 ? '#0088ff' : '#00ff9d');
            document.getElementById('scoreDisplay').innerText = player.score;
            document.getElementById('coinDisplay').innerText = player.coins;
            document.getElementById('waveDisplay').innerText = wave;
            
            if(player.canDash) {
                const dashP = 100 - ((player.dashCooldown / player.dashMaxCooldown) * 100);
                const dashBar = document.getElementById('dashBar');
                dashBar.style.width = `${dashP}%`;
                dashBar.parentElement.classList.toggle('dash-ready', player.dashCooldown <= 0);
            }
        }

        function animate() {
            if (!isPlaying || isShopOpen) return;
            requestAnimationFrame(animate);
            ctx.fillStyle = 'rgba(5, 5, 16, 0.3)'; ctx.fillRect(0, 0, canvas.width, canvas.height);

            player.update();
            player.draw();

            // --- L√ìGICA DO LASER ORBITAL (CORRIGIDA) ---
            if (player.laserTimer > 0) {
                player.laserTimer--;

                // 1. Desenhar o Laser
                const endX = player.x + Math.cos(player.angle) * 2000;
                const endY = player.y + Math.sin(player.angle) * 2000;

                ctx.save();
                ctx.beginPath();
                ctx.moveTo(player.x, player.y);
                ctx.lineTo(endX, endY);
                ctx.lineWidth = 40 + Math.sin(Date.now() / 50) * 10;
                ctx.strokeStyle = 'rgba(0, 243, 255, 0.2)'; 
                ctx.lineCap = 'round';
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(player.x, player.y);
                ctx.lineTo(endX, endY);
                ctx.lineWidth = 10;
                ctx.strokeStyle = '#ffffff'; 
                ctx.stroke();
                ctx.restore();

                // 2. Colis√£o e Dano (Autom√°tico)
                for (let i = enemies.length - 1; i >= 0; i--) {
                    const e = enemies[i];
                    const dx = e.x - player.x;
                    const dy = e.y - player.y;
                    const t = (dx * Math.cos(player.angle) + dy * Math.sin(player.angle));
                    const closestX = player.x + t * Math.cos(player.angle);
                    const closestY = player.y + t * Math.sin(player.angle);
                    const dist = Math.hypot(e.x - closestX, e.y - closestY);

                    if (t > 0 && dist < e.radius + 35) {
                        e.hp -= 5; 
                        
                        // Flash Branco
                        ctx.save();
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                        ctx.beginPath(); ctx.arc(e.x, e.y, e.radius, 0, Math.PI*2); ctx.fill();
                        ctx.restore();

                        if (e.hp <= 0) {
                            createExplosion(e.x, e.y, e.color, 15);
                            player.score += e.value * 10;
                            coins.push(new Coin(e.x, e.y, Math.floor(e.value * (1 + Math.random()))));
                            enemies.splice(i, 1);
                        }
                    }
                }
            }

            // Spawn
            spawnTimer--;
            if(spawnTimer <= 0) {
                let type = 0;
                const r = Math.random();
                if (wave >= 10 && r > 0.98) type = 6; // Shooter
                else if (wave >= 8 && r > 0.95) type = 4;
                else if (wave >= 5 && r > 0.80) type = 3;
                else if (wave >= 4 && r > 0.70) type = 5;
                else if (wave >= 3 && r > 0.55) type = 1;
                else if (wave >= 2 && r > 0.40) type = 2;

                enemies.push(new Enemy(type, difficultyMult));
                spawnTimer = Math.max(15, 90 - (wave * 3));
            }

            // Proj√©teis
            projectiles.forEach((p, i) => {
                p.update(); p.draw();
                
                // Remover proj√©teis que sa√≠ram da tela
                if(p.x < 0 || p.x > canvas.width || p.y < 0 || p.y > canvas.height) {
                    projectiles.splice(i, 1);
                }
                
                // Colis√£o de proj√©teis inimigos com o jogador
                if(p instanceof EnemyProjectile && !player.invulnerable) {
                    const dist = Math.hypot(player.x - p.x, player.y - p.y);
                    if(dist < player.radius + p.radius) {
                        player.hp -= p.damage;
                        projectiles.splice(i, 1);
                        createExplosion(p.x, p.y, '#ff00ff', 5);
                        
                        if(player.hp <= 0) {
                            gameOver();
                        }
                    }
                }
            });

            // Moedas
            coins.forEach((c, i) => {
                c.update(); c.draw();
                const dist = Math.hypot(player.x - c.x, player.y - c.y);
                if(dist < player.radius + c.radius) {
                    player.coins += c.val;
                    totalCoinsCollected += c.val;
                    authManager.data.stats.totalCoins += c.val;
                    coins.splice(i, 1);
                    
                    // Verificar conquista de coleta de moedas
                    if(authManager.data.stats.totalCoins >= 1000 && !authManager.data.achievements.coin_collector) {
                        authManager.unlockAchievement('coin_collector');
                        authManager.addDiamonds(10);
                    }
                    
                    if(authManager.data.stats.totalCoins >= 5000 && !authManager.data.ships.speed) {
                        authManager.data.ships.speed = true;
                        authManager.unlockAchievement('unlock_speed');
                        authManager.saveData();
                    }
                }
                if(c.life <= 0) coins.splice(i, 1);
            });
            
            // Power-ups
            updatePowerups();

            // Inimigos e Colis√µes
            enemies.forEach((e, i) => {
                e.update(); e.draw();
                
                projectiles.forEach((p, pi) => {
                    // Ignorar colis√£o entre proj√©teis inimigos e inimigos
                    if(p instanceof EnemyProjectile) return;
                    
                    if(Math.hypot(p.x - e.x, p.y - e.y) < e.radius + p.radius) {
                        e.hp -= p.damage;
                        projectiles.splice(pi, 1);
                        createExplosion(e.x, e.y, '#ffff00', 3);
                        if(e.hp <= 0) {
                            createExplosion(e.x, e.y, e.color, 15);
                            player.score += e.value * 10;
                            coins.push(new Coin(e.x, e.y, Math.floor(e.value * (1+Math.random()))));
                            enemies.splice(i, 1);
                            enemiesKilled++;
                            authManager.data.stats.enemiesKilled++;
                            
                            // Chance de dropar power-up
                            const powerupChance = authManager.data.upgrades.powerup ? 0.15 : 0.05;
                            if(Math.random() < powerupChance) {
                                const powerupTypes = ['health', 'speed', 'damage', 'shield'];
                                const randomType = powerupTypes[Math.floor(Math.random() * powerupTypes.length)];
                                powerups.push(new Powerup(e.x, e.y, randomType));
                            }
                            
                            // Verificar conquistas
                            if(enemiesKilled === 1 && !authManager.data.achievements.first_blood) {
                                authManager.unlockAchievement('first_blood');
                                authManager.addDiamonds(5);
                            }
                            
                            if(authManager.data.stats.enemiesKilled >= 500 && !authManager.data.ships.tank) {
                                authManager.data.ships.tank = true;
                                authManager.unlockAchievement('unlock_tank');
                                authManager.saveData();
                            }
                            
                            if(player.score > wave * 1000) {
                                wave++; difficultyMult += 0.2;
                                player.coins += 70;
                                createExplosion(player.x, player.y, '#FFD700', 10);
                                
                                // Verificar conquista de ondas
                                if(wave >= 10 && !authManager.data.achievements.wave_master) {
                                    authManager.unlockAchievement('wave_master');
                                    authManager.addDiamonds(15);
                                }
                            }
                        }
                    }
                });

                if(!player.invulnerable && Math.hypot(player.x - e.x, player.y - e.y) < player.radius + e.radius) {
                    player.hp -= 20;
                    enemies.splice(i, 1);
                    createExplosion(player.x, player.y, '#ff0000', 10);
                    document.body.classList.add('shake');
                    setTimeout(()=>document.body.classList.remove('shake'), 500);
                    
                    if(player.hp <= 0) {
                        gameOver();
                    }
                }
            });

            particles.forEach((p, i) => { p.update(); p.draw(); if(p.alpha <= 0) particles.splice(i, 1); });
            
            // Atualizar progresso da miss√£o
            updateMissionProgress();
            
            updateHUD();
        }
        
        function gameOver() {
            isPlaying = false;
            const earnedDiamonds = Math.floor(player.score / 500); 
            authManager.addDiamonds(earnedDiamonds);

            if (!authManager.data.highScore || player.score > authManager.data.highScore) {
                authManager.data.highScore = player.score;
                authManager.saveData(); // Salva no Firebase
            }
            
            // Atualizar tempo total de jogo
            authManager.data.stats.totalPlayTime += (Date.now() - gameStartTime);
            
            // Verificar conquista de tempo de jogo
            if(authManager.data.stats.totalPlayTime >= 3600000 && !authManager.data.achievements.veteran) { // 1 hora em milissegundos
                authManager.unlockAchievement('veteran');
                authManager.addDiamonds(30);
            }
            
            document.getElementById('finalScore').innerText = player.score;
            document.getElementById('finalWave').innerText = wave;
            document.getElementById('finalDiamonds').innerText = `+${earnedDiamonds}`;
            
            document.getElementById('uiLayer').style.display = 'none';
            document.getElementById('missionTracker').classList.add('hidden');
            document.getElementById('gameOverScreen').style.display = 'flex';
        }

        // Inputs
        window.addEventListener('keydown', e => {
            const k = e.code;
            if(k === 'KeyW') keys.w = true;
            if(k === 'KeyA') keys.a = true;
            if(k === 'KeyS') keys.s = true;
            if(k === 'KeyD') keys.d = true;
            if(k === 'ShiftLeft' || k === 'ShiftRight') keys.shift = true;
            if(k === 'Space') { 
                e.preventDefault();
                if(!isShopOpen) toggleShop(); 
            }
        });
        window.addEventListener('keyup', e => {
            if(e.code === 'KeyW') keys.w = false;
            if(e.code === 'KeyA') keys.a = false;
            if(e.code === 'KeyS') keys.s = false;
            if(e.code === 'KeyD') keys.d = false;
            if(e.code === 'ShiftLeft' || e.code === 'ShiftRight') keys.shift = false;
        });
        canvas.addEventListener('mousemove', e => {
            const r = canvas.getBoundingClientRect();
            mouse.x = (e.clientX - r.left) * (canvas.width/r.width);
            mouse.y = (e.clientY - r.top) * (canvas.height/r.height);
        });
        canvas.addEventListener('mousedown', () => mouse.down = true);
        canvas.addEventListener('mouseup', () => mouse.down = false);
        
        // Anti-Cheat 
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.onkeydown = function(e) {
            if(e.keyCode == 123) return false;
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false;
        }

        const leaderboard = {
            open: function() {
                document.getElementById('leaderboardModal').style.display = 'flex';
                this.fetchScores();
            },
            
            close: function() {
                document.getElementById('leaderboardModal').style.display = 'none';
            },

            fetchScores: async function() {
                const listContainer = document.getElementById('leaderboardList');
                listContainer.innerHTML = '<div class="text-center text-cyan-500 animate-pulse mt-10">Buscando dados na rede neural...</div>';

                try {
                    let topPlayers = [];

                    if (isFirebaseConfigured) {
                        // Busca top 10 ordenado por HighScore
                        const snapshot = await db.collection('users')
                            .orderBy('highScore', 'desc')
                            .limit(10)
                            .get();
                        
                        snapshot.forEach(doc => {
                            const d = doc.data();
                            topPlayers.push({ 
                                name: d.name || "Desconhecido", 
                                score: d.highScore || 0 
                            });
                        });
                    } else {
                        // Dados falsos se n√£o tiver Firebase
                        topPlayers = [
                            { name: "NeonKing", score: 50000 },
                            { name: "VoidWalker", score: 42500 },
                            { name: "Voc√™ (Local)", score: authManager.data.highScore || 0 },
                            { name: "StarDust", score: 12000 }
                        ].sort((a, b) => b.score - a.score);
                    }

                    // Renderizar Lista
                    let html = '';
                    if (topPlayers.length === 0) {
                        html = '<div class="text-center text-gray-500 mt-10">Nenhum registro encontrado no setor.</div>';
                    } else {
                        topPlayers.forEach((p, index) => {
                            // Cores para top 3
                            let rankColor = 'text-gray-500';
                            let rowBorder = 'border-transparent';
                            
                            if (index === 0) { rankColor = 'text-yellow-400'; rowBorder = 'border-yellow-500/30 bg-yellow-900/10'; }
                            else if (index === 1) { rankColor = 'text-gray-300'; rowBorder = 'border-gray-500/30'; }
                            else if (index === 2) { rankColor = 'text-orange-400'; rowBorder = 'border-orange-500/30'; }
                            else { rowBorder = 'border-transparent hover:bg-gray-800/50'; }

                            html += `
                            <div class="grid grid-cols-3 items-center p-3 rounded mb-2 ${rowBorder} transition-all">
                                <div class="text-xl font-bold ${rankColor} pl-2">#${index + 1}</div>
                                <div class="text-center text-white truncate font-rajdhani text-lg">${p.name}</div>
                                <div class="text-right font-mono text-cyan-300 pr-2 tracking-widest">${p.score.toLocaleString()}</div>
                            </div>`;
                        });
                    }
                    
                    listContainer.innerHTML = html;

                } catch (error) {
                    console.error("Erro Ranking:", error);
                    listContainer.innerHTML = `
                        <div class="text-center text-red-400 p-6">
                            ERRO DE CONEX√ÉO<br>
                            <span class="text-xs text-gray-400">Verifique se o √çndice do Firestore foi criado ou se a API Key est√° v√°lida.</span>
                        </div>`;
                }
            }
        };
    </script>
</body>
</html>